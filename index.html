<style>

#headline {
  font-size: 3em;
  outline: 0;
  padding: 10px;
  width: 100%;
}
#headline:focus {
  border: 1px solid #fff200;
}
#popup-quote {
  background-color: efefef;
  display: none;
  font-size: 3em;
  padding: 10px;
}
#popup-quote div:hover {
  background: #fff200;
}
#popup-quote div {
  cursor: pointer;
  display: inline;
  padding: 0 10px;
}
</style>
<input id="headline" name="headline" type="text">
<div id="popup-quote">
  <div>"</div>
  <div>'</div>
  <div>&lsquo;</div>
  <div>&rsquo;</div>
  <div>&ldquo;</div>
  <div>&prime;</div>
  <div>&Prime;</div>
</div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>

var VOX = VOX || {};

VOX.Quotes = ( function ( $ ) {

  var headline = $( '#headline' );
  var selectedText;
  var range;

  var handleQuotes = function ( event ) {
    var headline = $( this );
    // reworked from smartquotes.js
    // https://github.com/kellym/smartquotesjs/blob/master/src/smartquotes.js
    var new_value = headline.val()
      .replace(/(\W|^)"/g, '$1\u201c')                                             // beginning "
      .replace(/(\u201c[^"]*)"([^"]*$|[^\u201c"]*\u201c)/g, '$1\u201d$2')          // ending "
      .replace(/([^0-9])"/g,'$1\u201d')                                            // remaining " at end of word
      .replace(/(\W|^)'(\S)/g, '$1\u2018')                                         // beginning '
      .replace(/(\W|^)\u2032(\S)/g,'$1\u2018$2')                                   // beginning '
      .replace(/(\W|^)\u2019(\S)/g,'$1\u2018$2')                                   // beginning '
      .replace(/([a-z])'([a-z])/ig, '$1\u2019$2')                                  // conjunction's possession
      .replace(/((\u2018[^']*)|[a-z])'([^0-9]|$)/ig, '$1\u2019$3')                 // ending '
      .replace(/(\u2018)([0-9]{2}[^\u2019]*)(\u2018([^0-9]|$)|$|\u2019[a-z])/ig, '\u2019$2$3')     // abbrev. years like '93
      .replace(/(\B|^)\u2018(?=([^\u2019]*\u2019\b)*([^\u2019\u2018]*\W[\u2019\u2018]\b|[^\u2019\u2018]*$))/ig, '$1\u2019') // backwards apostrophe
      .replace(/'''/g, '\u2034')                                                   // triple prime
      .replace(/("|'')/g, '\u2033')                                                // double prime
      .replace(/("|'')/g, '\u2033')                                                // double prime
      // .replace(/(\W|^)\u2019(\d+)/g,'$1\u2032$2')                                  // prime
      .replace(/'/g, '\u2032');                                                    // prime
    headline.val( new_value );
  };

  var addQuoteSelector = function ( event ) {
    // Get selected text
    selectedText = window.getSelection();
    range = selectedText.getRangeAt( 0 );
    selectedTextString = selectedText.toString();
    var length = selectedTextString.length;
    // if selected text is just one character
    // for now
    // build in better popup reasons in the future
    if ( length == 1 ) {
      $( '#popup-quote' ).show();
    }
  };

  var removeQuoteSelector = function ( event ) {
    $( '#popup-quote' ).hide();
  };

  var addQuote = function ( event ) {
    removeQuoteSelector();
    var newQuote = $( this ).html();
    range.deleteContents();
    range.insertNode( document.createTextNode( newQuote ) );
  };

  var addEvents = function () {
    headline.bind( 'propertychange change click input paste', handleQuotes );
    headline.bind( 'select', addQuoteSelector );
    $( '#popup-quote div' ).on( 'click', addQuote );
  };

  var init = function () {
    addEvents();
  }

  init();

} )( jQuery );
</script>
